<div class="modal-overlay" *ngIf="isModalOpen" (click)="isTypeDropdownOpen = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>{{ modalMode === 'add' ? 'Adicionar Novo Material' : 'Editar Material' }}</h2>
      <button class="close-button" (click)="closeModal()">&times;</button>
    </header>
    <section class="modal-body">
      <form [formGroup]="materialForm" (ngSubmit)="saveMaterial()">
        <div class="form-group">
          <label for="title">Título do Material</label>
          <input type="text" id="title" formControlName="title" placeholder="Ex: Guia Completo de Angular">
        </div>

        <div class="form-group">
          <label>Tipo</label>
          <div class="custom-dropdown">
            <button type="button" class="dropdown-toggle" (click)="isTypeDropdownOpen = !isTypeDropdownOpen">
              <span>{{ getMaterialTypeLabel(materialForm.get('materialType')?.value) }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron" [class.rotated]="isTypeDropdownOpen"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <div class="dropdown-menu" *ngIf="isTypeDropdownOpen">
              <a *ngFor="let type of materialTypes" (click)="selectType(type)">{{ getMaterialTypeLabel(type) }}</a>
            </div>
          </div>
        </div>

        <div class="form-group" *ngIf="materialForm.get('materialType')?.value === 'LINK'">
          <label for="url">URL do Link</label>
          <input type="url" id="url" formControlName="url" placeholder="https://exemplo.com">
        </div>
        <div class="form-group file-upload-group" *ngIf="materialForm.get('materialType')?.value && materialForm.get('materialType')?.value !== 'LINK'">
          <label for="file">Arquivo (PDF ou Vídeo)</label>
          <input type="file" id="file" #fileInput (change)="onFileSelected($event)">
          <button type="button" class="btn-upload" (click)="fileInput.click()">
             {{ selectedFile ? 'Trocar Arquivo' : 'Escolher Arquivo' }}
          </button>
          <span *ngIf="selectedFile" class="file-name">
             {{ selectedFile.name }}
          </span>
        </div>

        <div class="form-group">
          <label>Áreas de interesse</label>
          <p class="field-description">Clique nas categorias para expandir e selecione suas áreas de interesse</p>
          
          <div class="checkbox-grid" formArrayName="interestArea">
            <div *ngFor="let group of groupedInterestAreas" class="checkbox-section">
              <h4 class="section-header" (click)="toggleSection(group.key)">
                <span class="expand-icon" [class.expanded]="expandedSections[group.key]">▶</span>
                {{ group.name }}
              </h4>
              <div class="section-content" [class.expanded]="expandedSections[group.key]">
                <div *ngFor="let item of group.items" class="checkbox-item">
                  <input type="checkbox" [id]="'material-' + item.value" [value]="item.value" (change)="onMaterialInterestChange($event)" [checked]="materialInterestArray.value.includes(item.value)">
                  <label [for]="'material-' + item.value">{{ item.label }}</label>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="materialInterestArray.invalid && materialInterestArray.touched" class="error">
            Selecione pelo menos uma área de interesse.
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
          <button type="submit" [disabled]="materialForm.invalid || isLoading" class="btn btn-primary">
            {{ isLoading ? 'Salvando...' : (modalMode === 'add' ? 'Adicionar' : 'Salvar') }}
          </button>
        </div>
      </form>
    </section>
  </div>
</div>

<div class="library-container">
  <header class="library-header">
    <div class="header-title">
      <button class="btn-back" (click)="goBack()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      </button>
      <h1>Biblioteca de Apoio</h1>
    </div>
    <div class="header-actions">
      <button (click)="openModal('add')" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Adicionar Material
      </button>
    </div>
  </header>

  <section class="filter-section-wrapper">
    <button class="filter-toggle-button" (click)="toggleFilterForm()">
      <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        Filtrar por Categorias
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron" [class.rotated]="showFilterForm"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </button>
    <div class="filter-tags-container" *ngIf="showFilterForm">
      <button *ngFor="let area of interestAreas" class="filter-tag" [class.active]="isAreaSelected(area)" (click)="toggleAreaSelection(area)">
        {{ interestAreaLabels[area] }}
      </button>
      <button class="clear-filters-btn" *ngIf="filterInterestArray.length > 0" (click)="clearFilters()">
        Limpar Filtros
      </button>
    </div>
  </section>

  <div class="grid-container" *ngIf="!isLoading">
    <div *ngIf="filteredMaterials.length > 0; else noMaterials" class="materials-grid">
      <div *ngFor="let material of filteredMaterials" class="material-card">
        <div class="card-content">
          <div class="card-header">
            <span class="card-type">{{ getMaterialTypeLabel(material.materialType) }}</span>
            <div class="action-menu-container">
              <button class="action-menu-trigger" (click)="toggleActionMenu($event, material.id!)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
              </button>
              <div class="action-menu-dropdown" *ngIf="openMenuId === material.id">
                <button (click)="openModal('edit', material)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                   Editar
                </button>
                <button (click)="deleteMaterial(material.id!)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                  Excluir
                </button>
              </div>
            </div>
          </div>
          <h3>{{ material.title }}</h3>
          <p class="card-info">Adicionado em: {{ formatDate(material.createdAt) }}</p>
          <div class="card-tags">
            <span *ngFor="let area of material.interestArea" class="tag">{{ interestAreaLabels[area] }}</span>
          </div>
        </div>
        <div class="card-footer">
          <button *ngIf="material.filePath" (click)="downloadFile(material)" class="btn btn-view full-width">
            <svg *ngIf="material.materialType === 'VIDEO'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 8-6 4 6 4V8Z"></path><rect x="2" y="6" width="14" height="12" rx="2" ry="2"></rect></svg>
            <svg *ngIf="material.materialType !== 'VIDEO'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
            {{ material.materialType === 'VIDEO' ? 'Assistir' : 'Baixar' }}
          </button>
          <button *ngIf="material.url" (click)="openUrl(material.url!)" class="btn btn-view full-width">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
             Abrir Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <ng-template #noMaterials>
    <div class="empty-state">
      <p>Nenhum material encontrado.</p>
    </div>
  </ng-template>

  <div *ngIf="isLoading" class="loading-state">
    <p>Carregando materiais...</p>
  </div>
</div>